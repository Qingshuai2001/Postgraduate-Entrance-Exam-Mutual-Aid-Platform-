
<!-- 首页 -->
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>资料详情</title>
		<link rel="stylesheet" href="../../layui/css/layui.css">
		<!-- 样式 -->
		<link rel="stylesheet" href="../../css/style.css" />
		<!-- 主题（主要颜色设置） -->
		<link rel="stylesheet" href="../../css/theme.css" />
		<!-- 通用的css -->
		<link rel="stylesheet" href="../../css/common.css" />
		<link rel="stylesheet" href="../../elementui/index.css">
		<style>
			.layui-tab{
				margin-right: 143px;
				margin-left: 143px;
			}
			.avator{
				width: 30px;
				height: 30px;
				border-radius: 50%;
			}

			.layui-input-block {
				margin-left: 110px;
				margin-right: 00px;
				min-height: 36px;
			}
			/*.back{*/
			/*	background-image: linear-gradient(to top, #f3e7e9 0%, #e3eeff 99%, #e3eeff 100%);*/
			/*}*/
			.data-detail{
				background: white;
			}
			.layui-col-md7 {
				width: 100%;
				background: white;
			}

			body{
				/*background-image: linear-gradient(to right, #3ab5b0 0%, #3d99be 31%, #56317a 100%);*/
				/*background-image: linear-gradient(to right, #243949 0%, #517fa4 100%);*/
				background-image: linear-gradient(-225deg, #473B7B 0%, #3584A7 51%, #30D2BE 100%);
			}
		</style>
	</head>
	<body class="back">
	<div style="position: fixed;top: 0;left:0;bottom: 0;right: 0;z-index: 0">
		<canvas id="canvas" ></canvas>
	</div>

		<div id="app">

			<div class="data-detail">
				<div class="data-detail-breadcrumb">
					<span class="layui-breadcrumb">
						<a href="../home/home.html">首页</a>
						<a><cite>{{title}}</cite></a>
					</span>
					
<!--					<a @click="store()" href="javascript:void(0)">-->
<!--						<i class="layui-icon" style="font-size: 20px;color: red;">&#xe67a;</i>点我收藏-->
<!--					</a>-->

					<div class="layui-input-block">
						<el-button type="danger" round v-on:click="store" >
							<i class="layui-icon" style="font-size: 20px;color: red;">&#xe67a;</i>
							点击收藏</el-button>
					</div>
                    					
				</div>
				<div class="layui-row">

					</div>
					<div class="layui-col-md7" style="padding-left: 0px;">
						<h1 class="title">{{title}}</h1>
						
												
						<div v-if="detail.price" class="detail-item">
							<span>价格：</span>
							<span class="price" v-if="detail.price==0">
								免费
							</span>
							<span class="price" v-else>
								{{detail.price}}元
							</span>
						</div>


						<div class="detail-item">
							<span>分类：</span>
							<span class="desc">
								{{detail.categoryName}}
							</span>
						</div>
						<div class="detail-item">
							<span>购买量：</span>
							<span class="desc">
								{{detail.downNum}}
							</span>
						</div>

						<div class="detail-item">
							<div>图片：</div>
							<p style=" overflow: hidden; text-align: left;">
								<img style="max-width: 400px;" :src="detail.picture?detail.picture.split(',')[0]:''" alt="" class="maxW">
							</p>
						</div>



						<div class="detail-item">
							
						<div class="num-picker"  v-if="detail.price!=0">
								<button type="button" @click="quantity>0?quantity--:quantity" class="layui-btn layui-btn-primary">-</button>
								<input type="number" v-model="quantity" id="quantity" name="quantity" class="layui-input" disabled="disabled"></input>
								<button type="button" @click="quantity++" class="layui-btn layui-btn-primary">+</button>
						</div>
							<button v-if="detail.price!=0"  @click="addCartTap" type="button" class="layui-btn layui-btn-warm">
								添加到购物车
							</button>
							
							<button v-if="detail.price!=0" @click="buyTap" type="button" class="layui-btn btn-submit">
								立即购买
							</button>
							
							
						</div>
						
						<div class="detail-item" style="text-align: right;">

						</div>
					</div>
				</div>

				<div class="layui-row">
					<div class="layui-tab layui-tab-card">
						
						<ul class="layui-tab-title">
							<li class="layui-this">简介</li><li>内容</li><li>评论</li>
						</ul>
						
						<div class="layui-tab-content">
							
							<div class="layui-tab-item layui-show">
								<div v-html="detail.introduction"></div>
							</div>

							<div class="layui-tab-item">

								<el-input
										type="textarea"
										:autosize="{ minRows: 2, maxRows: 4}"
										placeholder="请输入内容"
										v-model="detail.content" readonly="true">
								</el-input>
<!--								<div v-html="detail.content"></div>-->
							</div>
							<div class="layui-tab-item">
								<div class="message-container">
									<form class="layui-form message-form" style="padding-right: 20px;border-bottom: 0;">
										<div class="layui-form-item layui-form-text">
											<label class="layui-form-label">评论</label>
											<div class="layui-input-block">
												<textarea name="content" required lay-verify="required" placeholder="请输入内容" class="layui-textarea"></textarea>
											</div>
										</div>
										<div class="layui-form-item">
											<div class="layui-input-block">
												<button class="layui-btn btn-submit" lay-submit lay-filter="*">立即提交</button>
												<button type="reset" class="layui-btn layui-btn-primary">重置</button>
											</div>
										</div>
									</form>
									<div class="message-list">
										<div class="message-item" v-for="(item,index) in dataList" v-bind:key="index">
											<div class="username-container">
<!--												<img class="avator" src="../../img/avator.png">-->
<!--												<span class="username">用户：{{item.userid}}</span>-->
												<img class="avator" :src="item.avatar ? item.avatar.split(',')[0]:image">
												<span class="username"><i class="el-icon-s-custom"></i>{{item.userName}}说: </span> &nbsp;&nbsp;{{item.content}}   <span style="margin-right: 10px;margin-left: 30px;"><i class="el-icon-time"></i>:{{item.addTime}}</span>

											</div>
<!--											<div class="content">-->
<!--												<span class="message">-->
<!--													{{item.content}}-->
<!--												</span>-->
<!--											</div>-->
										</div>
									</div>
									<div class="pager" id="pager"></div>
								</div>
							</div>
							
						</div>
					</div>
				</div>
			</div>

		</div>


		<script src="../../layui/layui.js"></script>
		<script src="../../js/vue.js"></script>
		<!-- 组件配置信息 -->
		<script src="../../js/config.js"></script>
		<!-- 扩展插件配置信息 -->
		<script src="../../modules/config.js"></script>
		<!-- 工具方法 -->
		<script src="../../js/utils.js"></script>
		<script src="../../elementui/index.js"></script>

		<script>
			var vue = new Vue({
				el: '#app',
				data: {

					// 数据详情
					detail: {
						id: 0
					},
					// 商品标题
					title: '',

					// 加入购物车数量
					quantity: 1,
					// 当前详情页表
					detailTable: 'material',
					// 评论列表
					dataList: [],
					image: '../../img/avator.png'

				},

				methods: {
					jump(url) {
						jump(url)
					},
					isAuth(tablename, button) {
						return isFrontAuth(tablename, button)
					},

					// 跨表
					// onAcrossTap(acrossTable){
					// 	localStorage.setItem('crossTable',`ziliaoxinxi`);
					// 	localStorage.setItem('crossObj', JSON.stringify(this.detail));
					// 	jump(`../${acrossTable}/add.html?corss=true`);
					// },


					// 添加到购物车
					addCartTap() {

						// 查询是否已经添加到购物车
						layui.http.request('cart/list', 'get', {
							userId: localStorage.getItem('userId'),
							tableName: `${this.detailTable}`,
							goodId: this.detail.id
						}, (res) => {
							if (res.data.list.length > 0) {
								layer.msg("该商品已经添加到购物车", {
									time: 2000,
									icon: 5
								});
								return
							}
							layui.http.requestJson('cart/save', 'post', {
								tableName: `${this.detailTable}`,
								goodId: this.detail.id,
								goodName: this.title,
								picture: this.detail.picture,
								quantity: this.quantity,
								userId: localStorage.getItem('userId'),
								price: this.detail.price,
							}, (res) => {
								layer.msg("添加到购物车成功", {
									time: 2000,
									icon: 6
								});
							});
						})
					},
					

					buyTap() {

						// 保存到storage中，在确认下单页面中获取要购买的商品
						localStorage.setItem('orderGoods', JSON.stringify([{
							tableName: `${this.detailTable}`,
							goodId: this.detail.id,
							goodName: this.title,
							picture: this.detail.picture,
							quantity: this.quantity,
							userId: localStorage.getItem('userId'),
							price: this.detail.price,
						}]));
						// 跳转到确认下单页面
						jump('../orders/confirm.html');
					},
										
					
					// 收藏商品
					store() {
						layui.http.requestJson('store/save', 'post', {
							createdBy: localStorage.getItem('userId'),
							title: this.title,
							picture: this.detail.picture,
							refid: this.detail.id,
							tableName: this.detailTable
						}, function(res) {
							layer.msg(`收藏成功`, {
								time: 2000,
								icon: 6
							});
						});
					},
                    					
					
				}
			})

			layui.use(['layer', 'form', 'element', 'carousel', 'http', 'jquery', 'laypage'], function() {
				var layer = layui.layer;
				var element = layui.element;
				var form = layui.form;
				var carousel = layui.carousel;
				var http = layui.http;
				var jquery = layui.jquery;
				var laypage = layui.laypage;

				var limit = 8;

				// 数据ID
				var id = http.getParam('id');
				vue.detail.id = id;

				// 商品信息
				http.request(`${vue.detailTable}/detail/` + id, 'get', {}, function(res) {
					// 详情信息
					vue.detail = res.data
					vue.title = vue.detail.title;
					
				});

				// 获取评论
				http.request(`discuss${vue.detailTable}/list`, 'get', {
					page: 1,
					limit: limit,
					refid: vue.detail.id
				}, function(res) {
					vue.dataList = res.data.list
					// 分页
					laypage.render({
						elem: 'pager',
						count: res.data.total,
						limit: limit,
						jump: function(obj, first) {
							//首次不执行
							if (!first) {
								http.request(`discuss${vue.detailTable}/list`, 'get', {
									page: obj.curr,
									limit: obj.limit,
									refid: vue.detail.id
								}, function(res) {
									vue.dataList = res.data.list
								})
							}
						}
					});
				})
				
				// 提交评论
				form.on('submit(*)', function(data) {
					data = data.field;
					data.userId = localStorage.getItem('userId')
					data.refid = vue.detail.id
					http.requestJson(`discuss${vue.detailTable}/save`, 'post', data, function(res) {
						layer.msg('评论成功', {
							time: 2000,
							icon: 6
						}, function() {
							window.location.reload();
						});
						return false
					});
					return false
				});
				
			});
		</script>
	<script type="text/javascript">
		const canvas = document.getElementById('canvas')
		const ctx = canvas.getContext('2d')
		let width = window.innerWidth
		let height = window.innerHeight

		let dotsNum = 80 // 点的数量
		let radius = 1 // 圆的半径，连接线宽度的一半
		let fillStyle = 'rgb(250,250,250)' // 点的颜色
		let lineWidth = radius * 2
		let connection = 120 // 连线最大距离
		let followLength = 80 // 鼠标跟随距离

		let dots = []
		let animationFrame = null
		let mouseX = null
		let mouseY = null

		function addCanvasSize () { // 改变画布尺寸
			width = window.innerWidth
			height = window.innerHeight
			canvas.width = width
			canvas.height = height
			ctx.clearRect(0, 0, width, height)
			dots = []
			if (animationFrame) window.cancelAnimationFrame(animationFrame)
			initDots(dotsNum)
			moveDots()
		}

		function mouseMove (e) {
			mouseX = e.clientX
			mouseY = e.clientY
		}

		function mouseOut (e) {
			mouseX = null
			mouseY = null
		}

		function mouseClick () {
			for (const dot of dots) dot.elastic()
		}

		class Dot {
			constructor(x, y) {
				this.x = x
				this.y = y
				this.speedX = Math.random() * 2 - 1
				this.speedY = Math.random() * 2 - 1
				this.follow = false
			}
			draw () {
				ctx.beginPath()
				ctx.arc(this.x, this.y, radius, 0, 2 * Math.PI)
				ctx.fill()
				ctx.closePath()
			}
			move () {
				if (this.x >= width || this.x <= 0) this.speedX = -this.speedX
				if (this.y >= height || this.y <= 0) this.speedY = -this.speedY
				this.x += this.speedX
				this.y += this.speedY
				if (this.speedX >= 1) this.speedX--
				if (this.speedX <= -1) this.speedX++
				if (this.speedY >= 1) this.speedY--
				if (this.speedY <= -1) this.speedY++
				this.correct()
				this.connectMouse()
				this.draw()
			}
			correct () { // 根据鼠标的位置修正
				if (!mouseX || !mouseY) return
				let lengthX = mouseX - this.x
				let lengthY = mouseY - this.y
				const distance = Math.sqrt(lengthX ** 2 + lengthY ** 2)
				if (distance <= followLength) this.follow = true
				else if (this.follow === true && distance > followLength && distance <= followLength + 8) {
					let proportion = followLength / distance
					lengthX *= proportion
					lengthY *= proportion
					this.x = mouseX - lengthX
					this.y = mouseY - lengthY
				} else this.follow = false
			}
			connectMouse () { // 点与鼠标连线
				if (mouseX && mouseY) {
					let lengthX = mouseX - this.x
					let lengthY = mouseY - this.y
					const distance = Math.sqrt(lengthX ** 2 + lengthY ** 2)
					if (distance <= connection) {
						opacity = (1 - distance / connection) * 0.5
						ctx.strokeStyle = `rgba(255,255,255,${opacity})`
						ctx.beginPath()
						ctx.moveTo(this.x, this.y)
						ctx.lineTo(mouseX, mouseY);
						ctx.stroke();
						ctx.closePath()
					}
				}
			}
			elastic () { // 鼠标点击后的弹射
				let lengthX = mouseX - this.x
				let lengthY = mouseY - this.y
				const distance = Math.sqrt(lengthX ** 2 + lengthY ** 2)
				if (distance >= connection) return
				const rate = 1 - distance / connection // 距离越小此值约接近1
				this.speedX = 40 * rate * -lengthX / distance
				this.speedY = 40 * rate * -lengthY / distance
			}
		}

		function initDots (num) { // 初始化粒子
			ctx.fillStyle = fillStyle
			ctx.lineWidth = lineWidth
			for (let i = 0; i < num; i++) {
				const x = Math.floor(Math.random() * width)
				const y = Math.floor(Math.random() * height)
				const dot = new Dot(x, y)
				dot.draw()
				dots.push(dot)
			}
		}

		function moveDots () { // 移动并建立点与点之间的连接线
			ctx.clearRect(0, 0, width, height)
			for (const dot of dots) {
				dot.move()
			}
			for (let i = 0; i < dots.length; i++) {
				for (let j = i; j < dots.length; j++) {
					const distance = Math.sqrt((dots[i].x - dots[j].x) ** 2 + (dots[i].y - dots[j].y) ** 2)
					if (distance <= connection) {
						opacity = (1 - distance / connection) * 0.5
						ctx.strokeStyle = `rgba(255,255,255,${opacity})`
						ctx.beginPath()
						ctx.moveTo(dots[i].x, dots[i].y)
						ctx.lineTo(dots[j].x, dots[j].y);
						ctx.stroke();
						ctx.closePath()
					}
				}
			}
			animationFrame = window.requestAnimationFrame(moveDots)
		}

		addCanvasSize()

		initDots(dotsNum)
		moveDots()

		document.onmousemove = mouseMove
		document.onmouseout = mouseOut
		document.onclick = mouseClick
		window.onresize = addCanvasSize
	</script>
	</body>
	</body>
</html>
