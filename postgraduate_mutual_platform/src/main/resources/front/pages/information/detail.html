
<!-- 首页 -->
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>首页</title>
		<link rel="stylesheet" href="../../layui/css/layui.css">
		<!-- 样式 -->
		<link rel="stylesheet" href="../../css/style.css" />
		<!-- 主题（主要颜色设置） -->
		<link rel="stylesheet" href="../../css/theme.css" />
		<!-- 通用的css -->
		<link rel="stylesheet" href="../../css/common.css" />
		<link rel="stylesheet" href="../../css/blog/app.css" />
		<link rel="stylesheet" href="../../elementui/index.css">
		<link rel="stylesheet" href="../../css/markdown/github-markdown-light.min.css">
		<style>
			@media (max-width: 767px) { body { padding: 15px; } }
			body { box-sizing: border-box;
				min-width: 200px;
				max-width: 980px;
				margin: 0 auto;
				padding: 45px;
				background-size: cover;
				background: url("../../img/background/jiguang1.jpg") no-repeat center fixed;
				/*background: url("../../img/background/background.gif") ;*/
				/*background: url("../../img/background/90.gif") ;*/
			}
			.data-detail{
				width: 880px;
			}

			.el-button.is-round {
				border-radius: 20px;
				padding: 2px 23px;
			}
			.layui-input-block {
				margin-left: 110px;
				margin-right: 00px;
				min-height: 36px;
			}

			.avator{
				width: 30px;
				height: 30px;
				margin-left: 50px;
				margin-bottom: 10px;
				border-radius: 50%;
			}
			/*.data-detail{*/
			/*	background-image: linear-gradient(to top, #fff1eb 0%, #ace0f9 100%);*/
			/*}*/
		</style>

	</head>
	<body >
	<div style="position: fixed;top: 0;left:0;bottom: 0;right: 0;z-index: 0">
		<canvas id="canvas" ></canvas>
	</div>

		<div id="app">
			<div class="data-detail">
				<div class="data-detail-breadcrumb">
					<span class="layui-breadcrumb">
						<a href="../home/home.html">首页</a>
						<a><cite>{{title}}</cite></a>
					</span>
					
<!--					 <a v-on:click="store()" href="javascript:void(0)">-->
<!--						<i class="layui-icon" style="font-size: 20px;color: red;">&#xe67a;点我收藏</i>-->
<!--					</a>-->
					<div class="layui-input-block">
						<el-button type="danger" round v-on:click="store" >
							<i class="layui-icon" style="font-size: 20px;color: red;">&#xe67a;</i>
							点击收藏</el-button>
					</div>
                    					
				</div>
				<div class="layui-row">
					<div class="layui-col-md7" style="padding-left: 20px;">
						<h1 class="title">{{title}}</h1>

						<div class="detail-item">
							<span>类型：</span>
							<span class="desc">
								{{detail.categoryName}}
							</span>
						</div>
						<div class="detail-item">
							<span>发布日期：</span>
							<span class="desc">
								{{detail.publishTime}}
							</span>
						</div>

						<div class="detail-item">
						<span>发布人id：</span>
						<span class="desc">
								{{detail.createdBy}}
							</span>
						</div>

						<div class="detail-item">
							<span>点击量：</span>
							<span class="desc">
								{{detail.clickNum}}
							</span>
						</div>

						<div class="detail-item">
							<div><span>封面：</span></div>
							<p style=" overflow: hidden; text-align: left;">
								<img style="max-width: 500px;" :src="detail.picture?detail.picture.split(',')[0]:''" alt="" class="maxW">
							</p>
						</div>


						<div class="detail-item" style="text-align: right;">
						</div>
					</div>
				</div>
				

				<div class="layui-row">
					<div class="layui-tab layui-tab-card">
						<ul class="layui-tab-title">
							<li class="layui-this" >内容</li>
						</ul>
					</div>
						<div class="layui-tab-content">
							<div class="layui-tab-item layui-show">
								<div id="$m" class="markdown-body"></div>
							</div>
						</div>
					</div>
				<div class="layui-row">
					<div class="layui-tab layui-tab-card">
						<ul class="layui-tab-title">
							<li class="layui-this" >评论</li>
						</ul>
					</div>
					<form class="layui-form message-form" style="padding-right: 20px;border-bottom: 0;">
						<div class="layui-form-item layui-form-text">
							<label class="layui-form-label">评论</label>
							<div class="layui-input-block">
								<textarea name="content" required lay-verify="required"
										  placeholder="请输入内容" class="layui-textarea"></textarea>
							</div>
						</div>
						<div class="layui-form-item">
							<div class="layui-input-block">
								<button class="layui-btn btn-submit" lay-submit lay-filter="*">
									立即提交</button>
								<button type="reset" class="layui-btn layui-btn-primary">重置</button>
							</div>
						</div>
					</form>
					<div class="message-list">
						<div class="message-item" v-for="(item,index) in dataList" v-bind:key="index">
							<div class="username-container">

								<img class="avator" :src="item.avatar ? item.avatar.split(',')[0]:image">
								<span class="username"><i class="el-icon-s-custom"></i>{{item.userName}}说: </span> &nbsp;&nbsp;{{item.content}}   <span style="margin-right: 10px;margin-left: 30px;"><i class="el-icon-time"></i>:{{item.addTime}}</span>
							</div>

						</div>
					</div>
					<div class="pager" id="pager"></div>

				</div>
			</div>


		</div>


		<script src="../../layui/layui.js"></script>
		<script src="../../js/vue.js"></script>
		<!-- 组件配置信息 -->
		<script src="../../js/config.js"></script>
		<!-- 扩展插件配置信息 -->
		<script src="../../modules/config.js"></script>
		<!-- 工具方法 -->
		<script src="../../js/utils.js"></script>
		<script src="../../elementui/index.js"></script>

		<script type="text/javascript" src="../../css/markdown/marked.min.js"></script>


		<script>
			var vue = new Vue({
				el: '#app',
				data: {
					// 数据详情
					detail: {
						id: 0
					},
					// 标题
					title: '',

					// 当前详情页表
					detailTable: 'information',
					// 评论列表
					dataList: [],
					content: '',
					image: '../../img/avator.png'

				},

				methods: {
					jump(url) {
						jump(url)
					},
					isAuth(tablename, button) {
						return isFrontAuth(tablename, button)
					},


					// 跨表
					// onAcrossTap(acrossTable){
					// 	localStorage.setItem('crossTable',`kaoyanzixun`);
					// 	localStorage.setItem('crossObj', JSON.stringify(this.detail));
					// 	jump(`../${acrossTable}/add.html?corss=true`);
					// },

					
					 // 收藏
					store() {
						layui.http.requestJson('store/save', 'post', {
							createdBy: localStorage.getItem('userId'),
							title: this.title,
							picture: this.detail.picture,
							refid: this.detail.id,
							tableName: this.detailTable
						}, function(res) {
							layer.msg(`收藏成功`, {
								time: 2000,
								icon: 6
							});
						});
					},
                    					
					
				},

			})


			layui.use(['layer', 'form', 'element', 'carousel', 'http', 'jquery', 'laypage'], function() {
				var layer = layui.layer;
				var element = layui.element;
				var form = layui.form;
				var carousel = layui.carousel;
				var http = layui.http;
				var jquery = layui.jquery;
				var laypage = layui.laypage;

				var limit = 10;

				// 数据ID
				var id = http.getParam('id');
				vue.detail.id = id;

				// 信息
				http.request(`${vue.detailTable}/detail/` + id, 'get', {}, function(res) {
					// 详情信息
					vue.detail = res.data
					vue.content = vue.detail.content;
					vue.title = vue.detail.title;
					if(vue.content){
						$m.innerHTML = marked.parse(vue.content);
					}
					
				});

								// 获取评论
				http.request(`discuss${vue.detailTable}/list`, 'get', {
					page: 1,
					limit: limit,
					refid: vue.detail.id
				}, function(res) {
					vue.dataList = res.data.list
					// 分页
					laypage.render({
						elem: 'pager',
						count: res.data.total,
						limit: limit,
						jump: function(obj, first) {
							//首次不执行
							if (!first) {
								http.request(`discuss${vue.detailTable}/list`, 'get', {
									page: obj.curr,
									limit: obj.limit,
									refid: vue.detail.id
								}, function(res) {
									vue.dataList = res.data.list
								})
							}
						}
					});
				})
				
				// 提交评论
				form.on('submit(*)', function(data) {
					data = data.field;
					data.userId = localStorage.getItem('userId')
					data.refid = vue.detail.id
					http.requestJson(`discuss${vue.detailTable}/save`, 'post', data, function(res) {
						layer.msg('评论成功', {
							time: 2000,
							icon: 6
						}, function() {
							window.location.reload();
						});
						return false
					});
					return false
				});
				
			});
		</script>
	<script type="text/javascript">
		const canvas = document.getElementById('canvas')
		const ctx = canvas.getContext('2d')
		let width = window.innerWidth
		let height = window.innerHeight

		let dotsNum = 80 // 点的数量
		let radius = 1 // 圆的半径，连接线宽度的一半
		let fillStyle = 'rgb(250,250,250)' // 点的颜色
		let lineWidth = radius * 2
		let connection = 120 // 连线最大距离
		let followLength = 80 // 鼠标跟随距离

		let dots = []
		let animationFrame = null
		let mouseX = null
		let mouseY = null

		function addCanvasSize () { // 改变画布尺寸
			width = window.innerWidth
			height = window.innerHeight
			canvas.width = width
			canvas.height = height
			ctx.clearRect(0, 0, width, height)
			dots = []
			if (animationFrame) window.cancelAnimationFrame(animationFrame)
			initDots(dotsNum)
			moveDots()
		}

		function mouseMove (e) {
			mouseX = e.clientX
			mouseY = e.clientY
		}

		function mouseOut (e) {
			mouseX = null
			mouseY = null
		}

		function mouseClick () {
			for (const dot of dots) dot.elastic()
		}

		class Dot {
			constructor(x, y) {
				this.x = x
				this.y = y
				this.speedX = Math.random() * 2 - 1
				this.speedY = Math.random() * 2 - 1
				this.follow = false
			}
			draw () {
				ctx.beginPath()
				ctx.arc(this.x, this.y, radius, 0, 2 * Math.PI)
				ctx.fill()
				ctx.closePath()
			}
			move () {
				if (this.x >= width || this.x <= 0) this.speedX = -this.speedX
				if (this.y >= height || this.y <= 0) this.speedY = -this.speedY
				this.x += this.speedX
				this.y += this.speedY
				if (this.speedX >= 1) this.speedX--
				if (this.speedX <= -1) this.speedX++
				if (this.speedY >= 1) this.speedY--
				if (this.speedY <= -1) this.speedY++
				this.correct()
				this.connectMouse()
				this.draw()
			}
			correct () { // 根据鼠标的位置修正
				if (!mouseX || !mouseY) return
				let lengthX = mouseX - this.x
				let lengthY = mouseY - this.y
				const distance = Math.sqrt(lengthX ** 2 + lengthY ** 2)
				if (distance <= followLength) this.follow = true
				else if (this.follow === true && distance > followLength && distance <= followLength + 8) {
					let proportion = followLength / distance
					lengthX *= proportion
					lengthY *= proportion
					this.x = mouseX - lengthX
					this.y = mouseY - lengthY
				} else this.follow = false
			}
			connectMouse () { // 点与鼠标连线
				if (mouseX && mouseY) {
					let lengthX = mouseX - this.x
					let lengthY = mouseY - this.y
					const distance = Math.sqrt(lengthX ** 2 + lengthY ** 2)
					if (distance <= connection) {
						opacity = (1 - distance / connection) * 0.5
						ctx.strokeStyle = `rgba(255,255,255,${opacity})`
						ctx.beginPath()
						ctx.moveTo(this.x, this.y)
						ctx.lineTo(mouseX, mouseY);
						ctx.stroke();
						ctx.closePath()
					}
				}
			}
			elastic () { // 鼠标点击后的弹射
				let lengthX = mouseX - this.x
				let lengthY = mouseY - this.y
				const distance = Math.sqrt(lengthX ** 2 + lengthY ** 2)
				if (distance >= connection) return
				const rate = 1 - distance / connection // 距离越小此值约接近1
				this.speedX = 40 * rate * -lengthX / distance
				this.speedY = 40 * rate * -lengthY / distance
			}
		}

		function initDots (num) { // 初始化粒子
			ctx.fillStyle = fillStyle
			ctx.lineWidth = lineWidth
			for (let i = 0; i < num; i++) {
				const x = Math.floor(Math.random() * width)
				const y = Math.floor(Math.random() * height)
				const dot = new Dot(x, y)
				dot.draw()
				dots.push(dot)
			}
		}

		function moveDots () { // 移动并建立点与点之间的连接线
			ctx.clearRect(0, 0, width, height)
			for (const dot of dots) {
				dot.move()
			}
			for (let i = 0; i < dots.length; i++) {
				for (let j = i; j < dots.length; j++) {
					const distance = Math.sqrt((dots[i].x - dots[j].x) ** 2 + (dots[i].y - dots[j].y) ** 2)
					if (distance <= connection) {
						opacity = (1 - distance / connection) * 0.5
						ctx.strokeStyle = `rgba(255,255,255,${opacity})`
						ctx.beginPath()
						ctx.moveTo(dots[i].x, dots[i].y)
						ctx.lineTo(dots[j].x, dots[j].y);
						ctx.stroke();
						ctx.closePath()
					}
				}
			}
			animationFrame = window.requestAnimationFrame(moveDots)
		}

		addCanvasSize()

		initDots(dotsNum)
		moveDots()

		document.onmousemove = mouseMove
		document.onmouseout = mouseOut
		document.onclick = mouseClick
		window.onresize = addCanvasSize
	</script>
	</body>
</html>
